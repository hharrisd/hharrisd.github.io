<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Working with Django Custom Commands | Beto Harris</title><meta name=keywords content="python,django,custom,command"><meta name=description content="Introduction Django built-in commands are a powerful tool for performing a lot of management actions like starting a project or an application, creating and migrating migrations, running the internal server, creating users, and many more.
Likewise, Django allows the creation of admin commands to implement custom functionalities, which is a great resource to execute tasks needed in certain moments. Those tasks could be for instance:
Generating / Restoring backups Cleaning up databases Downloading reports Queuing messages Creating a custom command is pretty simple."><meta name=author content="Humberto Harris"><link rel=canonical href=https://hharrisd.github.io/posts/001-django-custom-command/><link crossorigin=anonymous href=/assets/css/stylesheet.bc1149f4a72aa4858d3a9f71462f75e5884ffe8073ea9d6d5761d5663d651e20.css integrity="sha256-vBFJ9KcqpIWNOp9xRi915YhP/oBz6p1tV2HVZj1lHiA=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://hharrisd.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://hharrisd.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://hharrisd.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://hharrisd.github.io/apple-touch-icon.png><link rel=mask-icon href=https://hharrisd.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Working with Django Custom Commands"><meta property="og:description" content="Introduction Django built-in commands are a powerful tool for performing a lot of management actions like starting a project or an application, creating and migrating migrations, running the internal server, creating users, and many more.
Likewise, Django allows the creation of admin commands to implement custom functionalities, which is a great resource to execute tasks needed in certain moments. Those tasks could be for instance:
Generating / Restoring backups Cleaning up databases Downloading reports Queuing messages Creating a custom command is pretty simple."><meta property="og:type" content="article"><meta property="og:url" content="https://hharrisd.github.io/posts/001-django-custom-command/"><meta property="og:image" content="https://hharrisd.github.io/img/posts/001/bells.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-10-06T18:03:18-05:00"><meta property="article:modified_time" content="2022-10-06T18:03:18-05:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://hharrisd.github.io/img/posts/001/bells.png"><meta name=twitter:title content="Working with Django Custom Commands"><meta name=twitter:description content="Introduction Django built-in commands are a powerful tool for performing a lot of management actions like starting a project or an application, creating and migrating migrations, running the internal server, creating users, and many more.
Likewise, Django allows the creation of admin commands to implement custom functionalities, which is a great resource to execute tasks needed in certain moments. Those tasks could be for instance:
Generating / Restoring backups Cleaning up databases Downloading reports Queuing messages Creating a custom command is pretty simple."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://hharrisd.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Working with Django Custom Commands","item":"https://hharrisd.github.io/posts/001-django-custom-command/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Working with Django Custom Commands","name":"Working with Django Custom Commands","description":"Introduction Django built-in commands are a powerful tool for performing a lot of management actions like starting a project or an application, creating and migrating migrations, running the internal server, creating users, and many more.\nLikewise, Django allows the creation of admin commands to implement custom functionalities, which is a great resource to execute tasks needed in certain moments. Those tasks could be for instance:\nGenerating / Restoring backups Cleaning up databases Downloading reports Queuing messages Creating a custom command is pretty simple.","keywords":["python","django","custom","command"],"articleBody":"Introduction Django built-in commands are a powerful tool for performing a lot of management actions like starting a project or an application, creating and migrating migrations, running the internal server, creating users, and many more.\nLikewise, Django allows the creation of admin commands to implement custom functionalities, which is a great resource to execute tasks needed in certain moments. Those tasks could be for instance:\nGenerating / Restoring backups Cleaning up databases Downloading reports Queuing messages Creating a custom command is pretty simple. To demonstrate it let’s assume this scenario:\nThere is an application that stores information from Unsplash photografies. This application needs to request information from Lorem Picsum, the Unsplash public API and store that information in a table, considering two ways to do it:\nJust load the new data to the table. Delete the previous data in the table before loading the new one. The model to store the data is:\nclass Photo(models.Model): id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False) author = models.CharField(max_length=200) width = models.IntegerField() height = models.IntegerField() url = models.URLField(max_length=200) download_url = models.URLField(max_length=200) Where to create custom commands? Django will look for commands to register in each installed application in those directories: management/commands.\nThe filename will be the name to call the command with the manage.py file. For this example, the command will be called python manage.py load-photo.\nThe load-photo.py file contains a Command class that inherits from BaseCommand. The three principal elements to implement the command are:\nhelp - Attribute to describe the command as a help text. add_arguments() - Method to parse the given arguments. handle() - Is the main method of the command and must be implemented. # General example from django.core.management.base import BaseCommand, CommandError class Command(BaseCommand): help = “Description” def add_arguments(self, parser): pass def handle(self, *args, **options): pass Parsing arguments This method uses the library argparse to parse the arguments and passes them to the handle method. In this example two arguments are defined, one positional (required) to indicate the number of images to load. The other is optional, to indicate if there will be a deletion of data before the load.\ndef add_arguments(self, parser): # This is a positional argument parser.add_argument('quantity', type=int, help='Number of images to load from the API. 30 by default. Max 100.') # This is an optional argument parser.add_argument('--delete', type=bool, action=argparse.BooleanOptionalAction, help='Deletes existing images before the load.') Handle method: The logic The methods validate_quantity, load_random_photos and deletes_existing_photos are implemented to achieve the functionality required for this example.\ndef validate_quantity(self, quantity: int) -\u003e bool | CommandError: \"\"\"Verifies that the number of image to fetch is between 1 and 100\"\"\" if quantity \u003c= 0: raise CommandError('The numbers of image to load must be grater than 0.') if quantity \u003e 100: raise CommandError('The numbers of image to load is up to 100.') return True def load_random_photos(self, number_of_img: int) -\u003e None: \"\"\"Request items from Unsplash API and load them in the table.\"\"\" response = requests.get(settings.UNSPLASH_IMAGES + str(number_of_img)) if response.status_code != 200: raise CommandError(f'Error in request. Status: {response.status_code}.') saved_counter = 0 for image in response.json(): photo = Photo(author=image['author'], width=image['width'], height=image['height'], url=image['url'], download_url=image['download_url']) photo.save() saved_counter += 1 self.stdout.write(self.style.SUCCESS(f'{saved_counter} photos loaded successfully.')) def deletes_existing_photos(self) -\u003e None: \"\"\"Deletes all records from the Photo models\"\"\" try: affected_records, _ = Photo.objects.all().delete() self.stdout.write(self.style.SUCCESS(f'Deleted {affected_records} records.')) except Exception: raise CommandError('Exception during deletion.') The handle method has the responsibility to implement the logic that calls these aforementioned methods.\ndef handle(self, *args, **options): \"\"\"Executes the logic of the command.\"\"\" if options['delete']: self.deletes_existing_photos() if self.validate_quantity(options['quantity']): self.load_random_photos(options['quantity']) Providing console output Django recommends the use of StringIO to provide output to the console: It facilitates command testing and with the use of syntax coloring is easy to return an intuitive message for success or error among others.\nTesting the Command The command can be tested using the method call_command from the django.core.management class.\nfrom io import StringIO from django.core.management import call_command, CommandError from django.test import TestCase def execute_command(quantity: int, delete: bool = False) -\u003e StringIO: out = StringIO() call_command('load-photo', quantity, delete=delete, stdout=out) return out class ManagePhotoDataTest(TestCase): def test_command_load_output(self): out = execute_command(25) self.assertIn('25 photos loaded successfully.', out.getvalue()) def test_command_delete_and_load_output(self): execute_command(25) out = execute_command(10, delete=True) self.assertIn('Deleted 25 records.', out.getvalue()) self.assertIn('10 photos loaded successfully.', out.getvalue()) def test_command_validates_negative_numbers_output(self): with self.assertRaises(CommandError): out = execute_command(-5) self.assertIn('The numbers of image to load must be grater than 0.', out.getvalue()) def test_command_validates_up_to_100_output(self): with self.assertRaises(CommandError): out = execute_command(550) self.assertIn('The numbers of image to load is up to 100.', out.getvalue()) Executing the command I hope this post helps you to understand this feature. For more detail about Custom Commands, I recommend reading Django’s official documentation.\n","wordCount":"747","inLanguage":"en","image":"https://hharrisd.github.io/img/posts/001/bells.png","datePublished":"2022-10-06T18:03:18-05:00","dateModified":"2022-10-06T18:03:18-05:00","author":{"@type":"Person","name":"Humberto Harris"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://hharrisd.github.io/posts/001-django-custom-command/"},"publisher":{"@type":"Organization","name":"Beto Harris","logo":{"@type":"ImageObject","url":"https://hharrisd.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://hharrisd.github.io/ accesskey=h title="Beto Harris (Alt + H)">Beto Harris</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://hharrisd.github.io/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://hharrisd.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://hharrisd.github.io/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://hharrisd.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://hharrisd.github.io/about/ title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://hharrisd.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://hharrisd.github.io/posts/>Posts</a></div><h1 class=post-title>Working with Django Custom Commands</h1><div class=post-meta><span title='2022-10-06 18:03:18 -0500 -0500'>October 6, 2022</span>&nbsp;·&nbsp;4 min&nbsp;·&nbsp;Humberto Harris</div></header><figure class=entry-cover><img loading=lazy src=https://hharrisd.github.io/img/posts/001/bells.png alt="Django - Custom Commands"><p>Django - Custom Commands</p></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#introduction aria-label=Introduction>Introduction</a></li><li><a href=#where-to-create-custom-commands aria-label="Where to create custom commands?">Where to create custom commands?</a></li><li><a href=#parsing-arguments aria-label="Parsing arguments">Parsing arguments</a></li><li><a href=#handle-method-the-logic aria-label="Handle method: The logic">Handle method: The logic</a></li><li><a href=#providing-console-output aria-label="Providing console output">Providing console output</a></li><li><a href=#testing-the-command aria-label="Testing the Command">Testing the Command</a></li><li><a href=#executing-the-command aria-label="Executing the command">Executing the command</a></li></ul></div></details></div><div class=post-content><h2 id=introduction>Introduction<a hidden class=anchor aria-hidden=true href=#introduction>#</a></h2><p>Django built-in commands are a powerful tool for performing a lot of management actions like starting a project or an application, creating and migrating migrations, running the internal server, creating users, and many more.</p><p>Likewise, Django allows the creation of admin commands to implement custom functionalities, which is a great resource to execute tasks needed in certain moments. Those tasks could be for instance:</p><ul><li>Generating / Restoring backups</li><li>Cleaning up databases</li><li>Downloading reports</li><li>Queuing messages</li></ul><p>Creating a custom command is pretty simple. To demonstrate it let’s assume this scenario:</p><p>There is an application that stores information from Unsplash photografies. This application needs to request information from <a href=https://picsum.photos>Lorem Picsum, the Unsplash public API</a> and store that information in a table, considering two ways to do it:</p><ol><li>Just load the new data to the table.</li><li>Delete the previous data in the table before loading the new one.</li></ol><p>The model to store the data is:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Photo</span>(models<span style=color:#f92672>.</span>Model):
</span></span><span style=display:flex><span>    id <span style=color:#f92672>=</span> models<span style=color:#f92672>.</span>UUIDField(primary_key<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>, default<span style=color:#f92672>=</span>uuid<span style=color:#f92672>.</span>uuid4, editable<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>)
</span></span><span style=display:flex><span>    author <span style=color:#f92672>=</span> models<span style=color:#f92672>.</span>CharField(max_length<span style=color:#f92672>=</span><span style=color:#ae81ff>200</span>)
</span></span><span style=display:flex><span>    width <span style=color:#f92672>=</span> models<span style=color:#f92672>.</span>IntegerField()
</span></span><span style=display:flex><span>    height <span style=color:#f92672>=</span> models<span style=color:#f92672>.</span>IntegerField()
</span></span><span style=display:flex><span>    url <span style=color:#f92672>=</span> models<span style=color:#f92672>.</span>URLField(max_length<span style=color:#f92672>=</span><span style=color:#ae81ff>200</span>)
</span></span><span style=display:flex><span>    download_url <span style=color:#f92672>=</span> models<span style=color:#f92672>.</span>URLField(max_length<span style=color:#f92672>=</span><span style=color:#ae81ff>200</span>)
</span></span></code></pre></div><h2 id=where-to-create-custom-commands>Where to create custom commands?<a hidden class=anchor aria-hidden=true href=#where-to-create-custom-commands>#</a></h2><p>Django will look for commands to register in each installed application in those directories: <strong>management/commands</strong>.</p><p><img loading=lazy src=/img/posts/001/custom-command-directory.png alt="Custom command directory"></p><p>The filename will be the name to call the command with the <strong>manage.py</strong> file. For this example, the command will be called <code>python manage.py load-photo</code>.</p><p>The <em>load-photo.py</em> file contains a <code>Command</code> class that inherits from <code>BaseCommand</code>. The three principal elements to implement the command are:</p><ul><li><strong>help</strong> - Attribute to describe the command as a help text.</li><li><strong>add_arguments()</strong> - Method to parse the given arguments.</li><li><strong>handle()</strong> - Is the main method of the command and must be implemented.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># General example</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> django.core.management.base <span style=color:#f92672>import</span> BaseCommand, CommandError
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Command</span>(BaseCommand):
</span></span><span style=display:flex><span>    help <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>“</span>Description<span style=color:#960050;background-color:#1e0010>”</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>add_arguments</span>(self, parser):
</span></span><span style=display:flex><span>	    <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>handle</span>(self, <span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>options):
</span></span><span style=display:flex><span>	    <span style=color:#66d9ef>pass</span>
</span></span></code></pre></div><h2 id=parsing-arguments>Parsing arguments<a hidden class=anchor aria-hidden=true href=#parsing-arguments>#</a></h2><p>This method uses the library <a href=https://docs.python.org/3/library/argparse.html>argparse</a> to parse the arguments and passes them to the handle method. In this example two arguments are defined, one positional (required) to indicate the number of images to load. The other is optional, to indicate if there will be a deletion of data before the load.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>add_arguments</span>(self, parser):
</span></span><span style=display:flex><span>    <span style=color:#75715e># This is a positional argument</span>
</span></span><span style=display:flex><span>    parser<span style=color:#f92672>.</span>add_argument(<span style=color:#e6db74>&#39;quantity&#39;</span>, type<span style=color:#f92672>=</span>int, help<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;Number of images to load from the API. 30 by default. Max 100.&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># This is an optional argument</span>
</span></span><span style=display:flex><span>    parser<span style=color:#f92672>.</span>add_argument(<span style=color:#e6db74>&#39;--delete&#39;</span>, type<span style=color:#f92672>=</span>bool, action<span style=color:#f92672>=</span>argparse<span style=color:#f92672>.</span>BooleanOptionalAction,
</span></span><span style=display:flex><span>                        help<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;Deletes existing images before the load.&#39;</span>)
</span></span></code></pre></div><h2 id=handle-method-the-logic>Handle method: The logic<a hidden class=anchor aria-hidden=true href=#handle-method-the-logic>#</a></h2><p>The methods <strong>validate_quantity</strong>, <strong>load_random_photos</strong> and <strong>deletes_existing_photos</strong> are implemented to achieve the functionality required for this example.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>validate_quantity</span>(self, quantity: int) <span style=color:#f92672>-&gt;</span> bool <span style=color:#f92672>|</span> CommandError:
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;Verifies that the number of image to fetch is between 1 and 100&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> quantity <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> CommandError(<span style=color:#e6db74>&#39;The numbers of image to load must be grater than 0.&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> quantity <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>100</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> CommandError(<span style=color:#e6db74>&#39;The numbers of image to load is up to 100.&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>load_random_photos</span>(self, number_of_img: int) <span style=color:#f92672>-&gt;</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;Request items from Unsplash API and load them in the table.&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    response <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>get(settings<span style=color:#f92672>.</span>UNSPLASH_IMAGES <span style=color:#f92672>+</span> str(number_of_img))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> response<span style=color:#f92672>.</span>status_code <span style=color:#f92672>!=</span> <span style=color:#ae81ff>200</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> CommandError(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;Error in request. Status: </span><span style=color:#e6db74>{</span>response<span style=color:#f92672>.</span>status_code<span style=color:#e6db74>}</span><span style=color:#e6db74>.&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    saved_counter <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> image <span style=color:#f92672>in</span> response<span style=color:#f92672>.</span>json():
</span></span><span style=display:flex><span>        photo <span style=color:#f92672>=</span> Photo(author<span style=color:#f92672>=</span>image[<span style=color:#e6db74>&#39;author&#39;</span>], width<span style=color:#f92672>=</span>image[<span style=color:#e6db74>&#39;width&#39;</span>], height<span style=color:#f92672>=</span>image[<span style=color:#e6db74>&#39;height&#39;</span>], url<span style=color:#f92672>=</span>image[<span style=color:#e6db74>&#39;url&#39;</span>],
</span></span><span style=display:flex><span>                        download_url<span style=color:#f92672>=</span>image[<span style=color:#e6db74>&#39;download_url&#39;</span>])
</span></span><span style=display:flex><span>        photo<span style=color:#f92672>.</span>save()
</span></span><span style=display:flex><span>        saved_counter <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    self<span style=color:#f92672>.</span>stdout<span style=color:#f92672>.</span>write(self<span style=color:#f92672>.</span>style<span style=color:#f92672>.</span>SUCCESS(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;</span><span style=color:#e6db74>{</span>saved_counter<span style=color:#e6db74>}</span><span style=color:#e6db74> photos loaded successfully.&#39;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>deletes_existing_photos</span>(self) <span style=color:#f92672>-&gt;</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;Deletes all records from the Photo models&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        affected_records, _ <span style=color:#f92672>=</span> Photo<span style=color:#f92672>.</span>objects<span style=color:#f92672>.</span>all()<span style=color:#f92672>.</span>delete()
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>stdout<span style=color:#f92672>.</span>write(self<span style=color:#f92672>.</span>style<span style=color:#f92672>.</span>SUCCESS(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;Deleted </span><span style=color:#e6db74>{</span>affected_records<span style=color:#e6db74>}</span><span style=color:#e6db74> records.&#39;</span>))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>Exception</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> CommandError(<span style=color:#e6db74>&#39;Exception during deletion.&#39;</span>)
</span></span></code></pre></div><p>The handle method has the responsibility to implement the logic that calls these aforementioned methods.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>handle</span>(self, <span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>options):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;Executes the logic of the command.&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> options[<span style=color:#e6db74>&#39;delete&#39;</span>]:
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>deletes_existing_photos()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> self<span style=color:#f92672>.</span>validate_quantity(options[<span style=color:#e6db74>&#39;quantity&#39;</span>]):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>load_random_photos(options[<span style=color:#e6db74>&#39;quantity&#39;</span>])
</span></span></code></pre></div><h2 id=providing-console-output>Providing console output<a hidden class=anchor aria-hidden=true href=#providing-console-output>#</a></h2><p>Django recommends the use of <a href=https://docs.python.org/3/library/io.html#io.StringIO>StringIO</a> to provide output to the console: It facilitates command testing and with the use of syntax coloring is easy to return an intuitive message for success or error among others.</p><h2 id=testing-the-command>Testing the Command<a hidden class=anchor aria-hidden=true href=#testing-the-command>#</a></h2><p>The command can be tested using the method <code>call_command</code> from the <code>django.core.management</code> class.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> io <span style=color:#f92672>import</span> StringIO
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> django.core.management <span style=color:#f92672>import</span> call_command, CommandError
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> django.test <span style=color:#f92672>import</span> TestCase
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>execute_command</span>(quantity: int, delete: bool <span style=color:#f92672>=</span> <span style=color:#66d9ef>False</span>) <span style=color:#f92672>-&gt;</span> StringIO:
</span></span><span style=display:flex><span>    out <span style=color:#f92672>=</span> StringIO()
</span></span><span style=display:flex><span>    call_command(<span style=color:#e6db74>&#39;load-photo&#39;</span>, quantity, delete<span style=color:#f92672>=</span>delete, stdout<span style=color:#f92672>=</span>out)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> out
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ManagePhotoDataTest</span>(TestCase):
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_command_load_output</span>(self):
</span></span><span style=display:flex><span>        out <span style=color:#f92672>=</span> execute_command(<span style=color:#ae81ff>25</span>)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertIn(<span style=color:#e6db74>&#39;25 photos loaded successfully.&#39;</span>, out<span style=color:#f92672>.</span>getvalue())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_command_delete_and_load_output</span>(self):
</span></span><span style=display:flex><span>        execute_command(<span style=color:#ae81ff>25</span>)
</span></span><span style=display:flex><span>        out <span style=color:#f92672>=</span> execute_command(<span style=color:#ae81ff>10</span>, delete<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertIn(<span style=color:#e6db74>&#39;Deleted 25 records.&#39;</span>, out<span style=color:#f92672>.</span>getvalue())
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assertIn(<span style=color:#e6db74>&#39;10 photos loaded successfully.&#39;</span>, out<span style=color:#f92672>.</span>getvalue())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_command_validates_negative_numbers_output</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>with</span> self<span style=color:#f92672>.</span>assertRaises(CommandError):
</span></span><span style=display:flex><span>            out <span style=color:#f92672>=</span> execute_command(<span style=color:#f92672>-</span><span style=color:#ae81ff>5</span>)
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>assertIn(<span style=color:#e6db74>&#39;The numbers of image to load must be grater than 0.&#39;</span>, out<span style=color:#f92672>.</span>getvalue())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_command_validates_up_to_100_output</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>with</span> self<span style=color:#f92672>.</span>assertRaises(CommandError):
</span></span><span style=display:flex><span>            out <span style=color:#f92672>=</span> execute_command(<span style=color:#ae81ff>550</span>)
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>assertIn(<span style=color:#e6db74>&#39;The numbers of image to load is up to 100.&#39;</span>, out<span style=color:#f92672>.</span>getvalue())
</span></span></code></pre></div><h2 id=executing-the-command>Executing the command<a hidden class=anchor aria-hidden=true href=#executing-the-command>#</a></h2><p><img loading=lazy src=/img/posts/001/terminal-example.png alt="Terminal Example"></p><p>I hope this post helps you to understand this feature. For more detail about Custom Commands, I recommend reading Django’s <a href=https://docs.djangoproject.com/en/4.1/howto/custom-management-commands/>official documentation</a>.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://hharrisd.github.io/tags/python/>python</a></li><li><a href=https://hharrisd.github.io/tags/django/>django</a></li><li><a href=https://hharrisd.github.io/tags/custom/>custom</a></li><li><a href=https://hharrisd.github.io/tags/command/>command</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://hharrisd.github.io/>Beto Harris</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>